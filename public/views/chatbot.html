<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .chat-container { width: 100%; max-width: 450px; height: 90vh; display: flex; flex-direction: column; border-radius: 10px; background: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .chat-box { flex-grow: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; }
        .message { padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; max-width: 75%; position: relative; word-wrap: break-word; }
        .user { background: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        .bot { background: #e9ecef; color: black; align-self: flex-start; border-bottom-left-radius: 0; }
        .cs { background: #28a745; color: white; align-self: flex-start; border-bottom-left-radius: 0; }
        .message-meta { font-size: 12px; color: black; margin-top: 5px; }
        .input-group { padding: 10px; }
        .status-bar { background: #f1f1f1; padding: 5px; text-align: center; font-size: 14px; color: #555; }
        textarea#message {
            resize: none;
            overflow-y: auto;
            max-height: 100px; /* Batasi tinggi agar tidak terlalu panjang */
            min-height: 40px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <h5 class="text-center p-3">Live Chat Bot</h5>
    <div class="status-bar" id="status-bar">ðŸ”µ Bot Online</div>
    <div id="chat-box" class="chat-box border rounded"></div>
    <!--    <div class="input-group">-->
    <!--        <input type="text" id="message" class="form-control" placeholder="Ketik pesan...">-->
    <!--        <button class="btn btn-primary" onclick="sendMessage()">Kirim</button>-->
    <!--    </div>-->
    <div class="input-group">
        <textarea id="message" class="form-control" placeholder="Ketik pesan..." rows="2"></textarea>
        <button class="btn btn-primary" onclick="sendMessage()">Kirim</button>
    </div>
</div>

<script>
    const chatBox = document.getElementById("chat-box");
    const messageInput = document.getElementById("message");
    const statusBar = document.getElementById("status-bar");

    const ws = new WebSocket("ws://localhost:8080/ws/live-chat");
    let wsCS = null;
    let csOnline = false; // Menandakan apakah CS sudah aktif

    // ws.onmessage = (event) => {
    //     if (event.data.includes("ðŸ”” Notifikasi")) {
    //         notifyCSJoin();
    //     } else {
    //         addMessage(event.data, "bot", "Bot");
    //     }
    // };
    ws.onmessage = (event) => {
        showTypingIndicator();

        setTimeout(() => {
            removeTypingIndicator();
            const botResponse = event.data;

            // Cek apakah bot tidak mengerti pertanyaan
            if (botResponse.toLowerCase().includes("maaf, saya tidak mengerti")) {
                addMessage(botResponse, "bot", "Agent");

                // Tambahkan tombol kontak customer service setelah jeda
                setTimeout(() => {
                    const msgDiv = document.createElement("div");
                    msgDiv.classList.add("message", "bot");
                    msgDiv.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 2px;">
                        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712100.png" alt="icon"
                             style="width: 30px; height: 30px; border-radius: 50%; margin-right: 8px;">
                        <strong>Agent</strong>
                    </div>
                    <div style="background: #e9ecef; padding: 10px 15px; border-radius: 15px; max-width: 100%;">
                        <p>Harap tunggu ...</p>
                    </div>
                `;
                    notifyCSJoin();
                    chatBox.appendChild(msgDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }, 1000); // Delay tambahan sebelum tombol muncul
            } else {
                addMessage(botResponse, "bot", "Agent");
            }
        }, 1000); // Delay 1 detik sebelum bot membalas
    };

    function showTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.id = "typing-indicator";
        typingDiv.classList.add("message", "bot");
        typingDiv.innerHTML = `<em>sedang mengetik...</em>`;
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingDiv = document.getElementById("typing-indicator");
        if (typingDiv) {
            typingDiv.remove();
        }
    }

    function notifyCSJoin() {
        addMessage("Customer Service telah diberitahu dan akan segera bergabung.", "bot", "Agent");

        setTimeout(() => {
            connectCustomerService();
        }, 2000);
    }

    function connectCustomerService() {
        if (!csOnline) {
            wsCS = new WebSocket("ws://localhost:8080/ws/cs");

            wsCS.onopen = () => {
                csOnline = true;
                statusBar.innerHTML = "ðŸŸ¢ Customer Service Online";
            };

            wsCS.onmessage = (event) => {
                addMessage(event.data, "cs", "Customer Service");
            };

            wsCS.onclose = () => {
                csOnline = false;
                statusBar.innerHTML = "ðŸ”µ Bot Online";
            };
        }
    }

    function sendMessage() {
        const msg = messageInput.value.trim();
        if (msg) {
            addMessage(msg, "user", "You");
            messageInput.value = "";

            if (csOnline) {
                wsCS.send(msg);
            } else {
                setTimeout(() => {
                    ws.send(msg);
                }, 1500);
            }
        }
    }

    function addMessage(text, sender, name) {
        const now = new Date();
        const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", sender);

        const userIcon = sender === "user"
            ? "https://cdn-icons-png.flaticon.com/512/147/147144.png"
            : sender === "cs"
                ? "https://cdn-icons-png.flaticon.com/512/4712/4712100.png"
                : "https://cdn-icons-png.flaticon.com/512/4712/4712100.png";

        msgDiv.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 2px;">
            <img src="${userIcon}" alt="icon" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 8px;">
            <strong>${name}</strong>
        </div>
        <div style="background: ${sender === 'user' ? '#007bff' : sender === 'cs' ? '#28a745' : '#e9ecef'};
                    color: ${sender === 'user' ? 'white' : 'black'};
                    padding: 10px 15px;
                    border-radius: 15px;
                    max-width: 100%;
                    display: inline-block;">
            ${text}
        </div>
        <div class='message-meta' style="font-size: 12px; color: black; margin-top: 5px;">
            ${time}
        </div>
    `;

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    messageInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
